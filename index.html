<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å‰æ—çœä¸€é˜Ÿ / äºŒé˜Ÿ å†°å£¶æˆåŠŸç‡ç»Ÿè®¡</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue",
            Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        h2 {
            font-size: 18px;
            margin-top: 16px;
        }
        .card {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            padding: 16px 20px;
            margin-bottom: 16px;
        }
        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1;
            min-width: 150px;
        }
        label {
            display: block;
            font-size: 13px;
            margin-bottom: 4px;
        }
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 6px 8px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        button {
            padding: 7px 14px;
            font-size: 13px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #1976d2;
            color: #fff;
        }
        .btn-primary:hover {
            background-color: #115293;
        }
        .btn-secondary {
            background-color: #e0e0e0;
        }
        .btn-secondary:hover {
            background-color: #c2c2c2;
        }
        .error {
            color: #d32f2f;
            font-size: 13px;
            margin-top: 4px;
        }
        .info {
            font-size: 13px;
            color: #555;
            margin-top: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 8px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            text-align: center;
        }
        th {
            background-color: #f0f0f0;
        }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            background-color: #e3f2fd;
            color: #1565c0;
        }
        .tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            background-color: #eeeeee;
            color: #424242;
        }
        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        .small-text {
            font-size: 12px;
            color: #666;
        }
        #teamChart {
            width: 100%;
            height: 320px;
            margin-top: 10px;
        }
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
        }
    </style>
    <!-- å¼•å…¥ ECharts CDN -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
<div class="container">
    <h1>ğŸ¥Œ å‰æ—çœä¸€é˜Ÿ / äºŒé˜Ÿ å†°å£¶æˆåŠŸç‡ç»Ÿè®¡ä¸åˆ†æ</h1>
    <p class="small-text">
        é€‚ç”¨äºå½•å…¥â€œå‰æ—çœä¸€é˜Ÿâ€â€œå‰æ—çœäºŒé˜Ÿâ€æ¯”èµ›æ•°æ®ï¼Œè‡ªåŠ¨è®¡ç®—æˆåŠŸç‡ã€ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨ï¼Œå¹¶å¯¼å‡º Excelï¼ˆCSVï¼‰ã€‚
        æˆåŠŸç‡å…¬å¼ï¼š<code>æˆåŠŸç‡ = å¾—åˆ†æ€»å’Œ / (4 Ã— æŠ•å£¶æ•°) Ã— 100%</code>
    </p>

    <!-- ä¸€ã€å½•å…¥æ•°æ® -->
    <div class="card">
        <h2>ä¸€ã€å½•å…¥æŠ•å£¶è®°å½•</h2>

        <div class="form-row">
            <div class="form-group">
                <label for="player">é€‰æ‰‹å§“å</label>
                <input type="text" id="player" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰">
            </div>
            <div class="form-group">
                <label for="team">é˜Ÿä¼åç§°</label>
                <select id="team">
                    <option value="å‰æ—çœä¸€é˜Ÿ">å‰æ—çœä¸€é˜Ÿ</option>
                    <option value="å‰æ—çœäºŒé˜Ÿ">å‰æ—çœäºŒé˜Ÿ</option>
                    <option value="å…¶ä»–é˜Ÿä¼">å…¶ä»–é˜Ÿä¼</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="end">å±€æ•°ï¼ˆEndï¼‰</label>
                <input type="number" id="end" min="1" max="20" value="1">
            </div>
            <div class="form-group">
                <label for="stoneIndex">æœ¬é˜Ÿç¬¬å‡ å£¶ï¼ˆ1~8ï¼‰</label>
                <input type="number" id="stoneIndex" min="1" max="8" value="1">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="shotType">æŠ•å£¶ç±»å‹</label>
                <select id="shotType">
                    <option value="Draw">Drawï¼ˆå ä½ï¼‰</option>
                    <option value="Take-out">Take-outï¼ˆå‡»æ‰“ï¼‰</option>
                    <option value="Guard">Guardï¼ˆæ©æŠ¤ï¼‰</option>
                    <option value="Freeze">Freezeï¼ˆè´´é ï¼‰</option>
                    <option value="Other">Otherï¼ˆå…¶ä»–ï¼‰</option>
                </select>
            </div>
            <div class="form-group">
                <label for="score">è¯„åˆ†ï¼ˆ0~4ï¼‰</label>
                <input type="number" id="score" min="0" max="4" value="3">
            </div>
        </div>

        <div class="form-row" style="margin-top: 4px;">
            <button class="btn-primary" id="addShotBtn">â• æ·»åŠ æŠ•å£¶è®°å½•</button>
            <button class="btn-secondary" id="clearAllBtn">ğŸ—‘ æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
        </div>

        <div id="errorMsg" class="error"></div>
        <div id="infoMsg" class="info"></div>
    </div>

    <!-- äºŒã€ç»Ÿè®¡ + å¯¼å‡º + å¯è§†åŒ– -->
    <div class="card" id="statsCard" style="display:none;">
        <h2>äºŒã€å‰æ—çœä¸€é˜Ÿ / äºŒé˜Ÿ æˆåŠŸç‡ç»Ÿè®¡ä¸å¯è§†åŒ–</h2>

        <div class="flex-between">
            <div>
                <span class="badge" id="overallBadge">æ•´ä½“æˆåŠŸç‡ï¼š0%</span>
            </div>
            <div class="small-text" id="totalShotsInfo"></div>
        </div>

        <div style="margin-top: 8px; margin-bottom: 8px;">
            <button class="btn-secondary" id="exportDetailBtn">ğŸ“¥ å¯¼å‡ºæ˜ç»† CSVï¼ˆå¯ç”¨ Excel æ‰“å¼€ï¼‰</button>
            <button class="btn-secondary" id="exportTeamStatsBtn">ğŸ“¥ å¯¼å‡ºé˜Ÿä¼ç»Ÿè®¡ CSV</button>
        </div>

        <h3>1. å‰æ—çœä¸€é˜Ÿ / å‰æ—çœäºŒé˜Ÿ æˆåŠŸç‡æŸ±çŠ¶å›¾</h3>
        <div id="teamChart"></div>

        <h3>2. æŒ‰é˜Ÿä¼ç»Ÿè®¡</h3>
        <table id="teamStatsTable">
            <thead>
            <tr>
                <th>é˜Ÿä¼</th>
                <th>æŠ•å£¶æ•°</th>
                <th>æ€»å¾—åˆ†</th>
                <th>æˆåŠŸç‡ï¼ˆ%ï¼‰</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>3. æŒ‰é€‰æ‰‹ç»Ÿè®¡</h3>
        <table id="playerStatsTable">
            <thead>
            <tr>
                <th>é€‰æ‰‹</th>
                <th>é˜Ÿä¼</th>
                <th>æŠ•å£¶æ•°</th>
                <th>æ€»å¾—åˆ†</th>
                <th>æˆåŠŸç‡ï¼ˆ%ï¼‰</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>4. æŒ‰é€‰æ‰‹ &amp; æŠ•å£¶ç±»å‹ç»Ÿè®¡</h3>
        <table id="detailStatsTable">
            <thead>
            <tr>
                <th>é€‰æ‰‹</th>
                <th>é˜Ÿä¼</th>
                <th>æŠ•å£¶ç±»å‹</th>
                <th>æŠ•å£¶æ•°</th>
                <th>æ€»å¾—åˆ†</th>
                <th>æˆåŠŸç‡ï¼ˆ%ï¼‰</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- ä¸‰ã€æ˜ç»†è®°å½• -->
    <div class="card" id="shotsCard" style="display:none;">
        <h2>ä¸‰ã€å·²å½•å…¥çš„æŠ•å£¶æ˜ç»†</h2>
        <table id="shotsTable">
            <thead>
            <tr>
                <th>#</th>
                <th>é€‰æ‰‹</th>
                <th>é˜Ÿä¼</th>
                <th>å±€æ•°</th>
                <th>æœ¬é˜Ÿç¬¬å‡ å£¶</th>
                <th>ç±»å‹</th>
                <th>è¯„åˆ†</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    let shots = [];
    let teamChart = null;

    function calcSuccessRate(scores) {
        if (!scores || scores.length === 0) return null;
        const sum = scores.reduce((a, b) => a + b, 0);
        return sum / (4 * scores.length) * 100;
    }

    function updateTeamChart(teamStats) {
        const chartDom = document.getElementById('teamChart');
        if (!teamChart) {
            teamChart = echarts.init(chartDom);
        }

        const teams = [];
        const rates = [];

        // åªå…³å¿ƒ å‰æ—çœä¸€é˜Ÿ / å‰æ—çœäºŒé˜Ÿ / å…¶ä»–é˜Ÿä¼ï¼ˆå¦‚æœæœ‰æ•°æ®ï¼‰
        const interestedTeams = ["å‰æ—çœä¸€é˜Ÿ", "å‰æ—çœäºŒé˜Ÿ", "å…¶ä»–é˜Ÿä¼"];
        interestedTeams.forEach(team => {
            if (teamStats[team]) {
                teams.push(team);
                rates.push(teamStats[team].rate);
            }
        });

        const option = {
            tooltip: {
                trigger: 'axis',
                formatter: function (params) {
                    const p = params[0];
                    return `${p.name}<br/>æˆåŠŸç‡ï¼š${p.value.toFixed(2)}%`;
                }
            },
            xAxis: {
                type: 'category',
                data: teams
            },
            yAxis: {
                type: 'value',
                name: 'æˆåŠŸç‡ (%)',
                min: 0,
                max: 100
            },
            series: [{
                name: 'æˆåŠŸç‡',
                type: 'bar',
                data: rates,
                label: {
                    show: true,
                    position: 'top',
                    formatter: function (p) {
                        return p.value.toFixed(1) + '%';
                    }
                }
            }]
        };
        teamChart.setOption(option);
    }

    function renderTables() {
        const statsCard = document.getElementById('statsCard');
        const shotsCard = document.getElementById('shotsCard');

        if (shots.length === 0) {
            statsCard.style.display = 'none';
            shotsCard.style.display = 'none';
            return;
        } else {
            statsCard.style.display = 'block';
            shotsCard.style.display = 'block';
        }

        const allScores = shots.map(s => s.score);
        const overallRate = calcSuccessRate(allScores);
        const overallBadge = document.getElementById('overallBadge');
        const totalScore = allScores.reduce((a, b) => a + b, 0);
        overallBadge.textContent = `æ•´ä½“æˆåŠŸç‡ï¼š${overallRate.toFixed(2)}%`;
        document.getElementById('totalShotsInfo').textContent =
            `å…± ${shots.length} å£¶ï¼Œæ€»å¾—åˆ† ${totalScore} åˆ†`;

        // æ˜ç»†è¡¨
        const shotsTbody = document.querySelector('#shotsTable tbody');
        shotsTbody.innerHTML = "";
        shots.forEach((shot, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${idx + 1}</td>
                <td>${shot.player}</td>
                <td>${shot.team}</td>
                <td>${shot.end}</td>
                <td>${shot.stoneIndex}</td>
                <td><span class="tag">${shot.shotType}</span></td>
                <td>${shot.score}</td>
            `;
            shotsTbody.appendChild(tr);
        });

        // æŒ‰é˜Ÿä¼ç»Ÿè®¡
        const teamMap = {};
        shots.forEach(shot => {
            const team = shot.team || "ï¼ˆæœªå¡«å†™ï¼‰";
            if (!teamMap[team]) {
                teamMap[team] = [];
            }
            teamMap[team].push(shot.score);
        });

        const teamStatsTbody = document.querySelector('#teamStatsTable tbody');
        teamStatsTbody.innerHTML = "";
        const teamStatsForChart = {};

        Object.keys(teamMap).forEach(team => {
            const scores = teamMap[team];
            const rate = calcSuccessRate(scores);
            const sum = scores.reduce((a, b) => a + b, 0);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${team}</td>
                <td>${scores.length}</td>
                <td>${sum}</td>
                <td>${rate.toFixed(2)}</td>
            `;
            teamStatsTbody.appendChild(tr);

            teamStatsForChart[team] = {
                count: scores.length,
                sum: sum,
                rate: rate
            };
        });

        // æ›´æ–°é˜Ÿä¼æŸ±çŠ¶å›¾ï¼ˆé‡ç‚¹ï¼šå‰æ—çœä¸€é˜Ÿ / å‰æ—çœäºŒé˜Ÿå¯¹æ¯”ï¼‰
        updateTeamChart(teamStatsForChart);

        // æŒ‰é€‰æ‰‹ç»Ÿè®¡
        const playerMap = {};
        shots.forEach(shot => {
            const key = `${shot.player}||${shot.team}`;
            if (!playerMap[key]) {
                playerMap[key] = [];
            }
            playerMap[key].push(shot.score);
        });

        const playerStatsTbody = document.querySelector('#playerStatsTable tbody');
        playerStatsTbody.innerHTML = "";
        Object.keys(playerMap).forEach(key => {
            const [player, team] = key.split("||");
            const scores = playerMap[key];
            const rate = calcSuccessRate(scores);
            const sum = scores.reduce((a, b) => a + b, 0);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${player}</td>
                <td>${team}</td>
                <td>${scores.length}</td>
                <td>${sum}</td>
                <td>${rate.toFixed(2)}</td>
            `;
            playerStatsTbody.appendChild(tr);
        });

        // æŒ‰é€‰æ‰‹ + æŠ•å£¶ç±»å‹ç»Ÿè®¡
        const detailMap = {};
        shots.forEach(shot => {
            const key = `${shot.player}||${shot.team}||${shot.shotType}`;
            if (!detailMap[key]) {
                detailMap[key] = [];
            }
            detailMap[key].push(shot.score);
        });

        const detailStatsTbody = document.querySelector('#detailStatsTable tbody');
        detailStatsTbody.innerHTML = "";
        Object.keys(detailMap).forEach(key => {
            const [player, team, shotType] = key.split("||");
            const scores = detailMap[key];
            const rate = calcSuccessRate(scores);
            const sum = scores.reduce((a, b) => a + b, 0);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${player}</td>
                <td>${team}</td>
                <td>${shotType}</td>
                <td>${scores.length}</td>
                <td>${sum}</td>
                <td>${rate.toFixed(2)}</td>
            `;
            detailStatsTbody.appendChild(tr);
        });
    }

    function exportCSV(filename, rows) {
        const processValue = (value) => {
            if (value === null || value === undefined) return "";
            const str = String(value);
            if (str.includes('"') || str.includes(',') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        };

        const csvContent = rows.map(row => row.map(processValue).join(",")).join("\n");
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        link.click();
        URL.revokeObjectURL(url);
    }

    document.getElementById('addShotBtn').addEventListener('click', function () {
        const player = document.getElementById('player').value.trim();
        const team = document.getElementById('team').value;
        const end = parseInt(document.getElementById('end').value, 10);
        const stoneIndex = parseInt(document.getElementById('stoneIndex').value, 10);
        const shotType = document.getElementById('shotType').value;
        const score = parseInt(document.getElementById('score').value, 10);

        const errorMsg = document.getElementById('errorMsg');
        const infoMsg = document.getElementById('infoMsg');
        errorMsg.textContent = "";
        infoMsg.textContent = "";

        if (!player) {
            errorMsg.textContent = "è¯·å¡«å†™é€‰æ‰‹å§“å";
            return;
        }
        if (!Number.isInteger(end) || end <= 0) {
            errorMsg.textContent = "å±€æ•°å¿…é¡»æ˜¯æ­£æ•´æ•°";
            return;
        }
        if (!Number.isInteger(stoneIndex) || stoneIndex < 1 || stoneIndex > 8) {
            errorMsg.textContent = "æœ¬é˜Ÿç¬¬å‡ å£¶å¿…é¡»åœ¨ 1~8 ä¹‹é—´";
            return;
        }
        if (!Number.isInteger(score) || score < 0 || score > 4) {
            errorMsg.textContent = "è¯„åˆ†å¿…é¡»æ˜¯ 0~4 çš„æ•´æ•°";
            return;
        }

        shots.push({ player, team, end, stoneIndex, shotType, score });
        infoMsg.textContent = `å·²æ·»åŠ ç¬¬ ${shots.length} æ¡è®°å½•ã€‚`;
        document.getElementById('stoneIndex').value = Math.min(stoneIndex + 1, 8);
        renderTables();
    });

    document.getElementById('clearAllBtn').addEventListener('click', function () {
        if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿ")) {
            shots = [];
            document.getElementById('errorMsg').textContent = "";
            document.getElementById('infoMsg').textContent = "å·²æ¸…ç©ºæ‰€æœ‰è®°å½•ã€‚";
            renderTables();
        }
    });

    document.getElementById('exportDetailBtn').addEventListener('click', function () {
        if (shots.length === 0) {
            alert("æš‚æ— æ•°æ®å¯ä»¥å¯¼å‡ºã€‚");
            return;
        }
        const header = ["é€‰æ‰‹", "é˜Ÿä¼", "å±€æ•°", "æœ¬é˜Ÿç¬¬å‡ å£¶", "æŠ•å£¶ç±»å‹", "è¯„åˆ†"];
        const rows = [header];
        shots.forEach(s => {
            rows.push([s.player, s.team, s.end, s.stoneIndex, s.shotType, s.score]);
        });
        exportCSV("å‰æ—çœå†°å£¶æŠ•å£¶æ˜ç»†.csv", rows);
    });

    document.getElementById('exportTeamStatsBtn').addEventListener('click', function () {
        if (shots.length === 0) {
            alert("æš‚æ— æ•°æ®å¯ä»¥å¯¼å‡ºã€‚");
            return;
        }
        const teamMap = {};
        shots.forEach(s => {
            const team = s.team || "ï¼ˆæœªå¡«å†™ï¼‰";
            if (!teamMap[team]) teamMap[team] = [];
            teamMap[team].push(s.score);
        });
        const header = ["é˜Ÿä¼", "æŠ•å£¶æ•°", "æ€»å¾—åˆ†", "æˆåŠŸç‡(%)"];
        const rows = [header];
        Object.keys(teamMap).forEach(team => {
            const scores = teamMap[team];
            const sum = scores.reduce((a, b) => a + b, 0);
            const rate = calcSuccessRate(scores);
            rows.push([team, scores.length, sum, rate.toFixed(2)]);
        });
        exportCSV("å‰æ—çœé˜Ÿä¼æˆåŠŸç‡ç»Ÿè®¡.csv", rows);
    });

    renderTables();
</script>
</body>
</html>
